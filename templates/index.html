<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centris Property Data Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Property Data Extractor</h1>
            <a href="/chart" class="text-blue-500 hover:text-blue-700">View Price Analysis Chart</a>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <form id="extractForm" class="space-y-4">
                <div>
                    <label for="url" class="block text-sm font-medium text-gray-700 mb-1">Centris URL</label>
                    <input type="url" id="url" name="url" 
                           class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="https://www.centris.ca/fr/..." required>
                </div>
                <button type="submit" 
                        class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Extract Data
                </button>
            </form>
        </div>

        <div id="results" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Results</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <tbody class="bg-white divide-y divide-gray-200" id="resultsTable">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4" role="alert">
            <span id="errorMessage" class="block"></span>
        </div>
    </div>

    <script>
        function formatValue(key, value) {
            // Add dollar sign for monetary values
            const moneyFields = ['price', 'municipal_assessment_total', 'municipal_terrain', 
                               'municipal_building', 'taxes_municipal', 'taxes_school', 'condo_fee'];
            if (moneyFields.includes(key)) {
                return `$${value}`;
            }
            
            // Add sqft for square footage
            if (key === 'sqft') {
                return `${value} sq.ft.`;
            }
            
            return value;
        }

        function formatKey(key) {
            // Convert snake_case to Title Case with spaces
            return key.split('_')
                     .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                     .join(' ');
        }

        document.getElementById('extractForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const url = document.getElementById('url').value;
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.getElementById('error');
            const resultsTable = document.getElementById('resultsTable');
            
            try {
                const response = await fetch('/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        url: url
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    errorDiv.classList.add('hidden');
                    resultsDiv.classList.remove('hidden');
                    
                    // Show cache status
                    const cacheStatus = data.fromCache ? 
                        '<div class="mb-4 text-sm text-gray-600">(Data loaded from cache)</div>' :
                        '<div class="mb-4 text-sm text-gray-600">(Fresh data from web)</div>';
                    resultsDiv.querySelector('h2').insertAdjacentHTML('afterend', cacheStatus);
                    
                    // Clear previous results
                    resultsTable.innerHTML = '';
                    
                    // Add each property to the table
                    Object.entries(data.data).forEach(([key, value]) => {
                        if (value !== null) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    ${formatKey(key)}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${formatValue(key, value)}
                                </td>
                            `;
                            resultsTable.appendChild(row);
                        }
                    });
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                resultsDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message;
            }
        });
    </script>
</body>
</html>
